---
title:  自顶向下计算机网络
date: 2020-3-25
---

#  自顶向下计算机网络

## 基本概念

- ISP: Internet Server Provider
- 拓扑：连线的方式
- 吞吐量：水管的大小
- 流量：网速
- 网络大小划分  
	- PAN:personal area network
	- LAN:局域网
	- MAN:城局域网
	- WAN:广局域网
	- 互联网（最大）


### IP地址

IPv4由32个位组成, 通常8个一组如192.168.1.1

前28个位为**网络编号**, 后4位为**主机编号**

**子网掩码**: 子网掩码的1对应网络位的编号, 子网掩码的0对应主机位的编号, 如255.255.255.0
- 作用: 限制广播的网络段, 将莫大的网络划分变小

**子网**表示方法: 网络编号 + 主机号 + / + 子网掩码1的个数
- 如:192.168.1.0/24, 子网掩码为255.255.255.0

**网段地址**: 每个网段的第0个地址
- 如:192.168.1.0. 0 = 0000 0000, 第0号主机

**广播地址**: 网段的最后一个IP地址
- 如:192.168.1.255. 255 = 1111 11111, 最后一个主机


### 路由

路由器的作用是实现跨网段的数据传输和转发, 类似于向导的作用, 这种指引的行为就叫最**路由**


#### 路由表

转发的指南

``` 
再linux下使用: route -n 可以查看路由表
:$ route -n  // 结果有8列
Destination  Gatewaty  Genmask  Flags  Metric  Ref  Use  Iface
```

分别为目的地址, 网关地址, 网关掩码, 最后一列为网卡

Flags带有G的说明是网关规则,
若数据包的目的IP与路由表的目的地址匹配,
路由器会将数据包(通过网卡)转发到Gateway中的网关地址,

如果Flags没有带G, 说明不是网关规则,
目标地址肯定就在本地链路通过用一个交换机相连

通过`traceroute -n IP`可以查看中途经过了哪些路由器

那路由表从何而来呢?
- 直连路由
    - 当主机配置好一个IP后, 会自动生成一个目的地址为该子网的路由
- 手动添加路由(静态路由)
- 通过动态路由协议获取


#### 路由器的功能

- DHCP
    - Dynamic Host Configuration Protocal, 动态主机配置协议
- (S)NAT/DNAT
    - (Source) Network Address Translation
    - 源地址转换NAT功能, 也叫IP伪装
    - 数据包在出路由器前会将数据包的源IP地址转换为路由器WAN口的公网IP地址, 以便被别人找到. 
        - 因为192.168.0.4等是私有的
- DNAT
    - 目的地址转换NAT功能
    - DNAT就是NAT的逆向
    - 实现公网对内部主机的主动访问


#### 路由器的桥接

把路由器的LAN合并到一起, 注意一下关键点
- 在一个LAN中IP地址必须唯一
    - 故从路由的的LAN必须和主路由属于同一网段, 并IP地址唯一
- 在一个LAN中最多有一个DHCP服务器
    - 故要关闭从路由的DHCP功能



## 参考模型  

### 分层原理

信宿机第n层收到的对象应与信源机第n层发出的对象完全一致.
好比做飞机的登机口和下机口

每一层都为他的上一层服务  
信息发送方要做什么:  
- 封装/打包:  
	- 然后从最高层逐层传到物理层
- 每一层上，数据都会被加上头部信息，用于信息传递  

收方要做什么:  
- 解封装/解包  


#### 典型的分层模型:

- ISO OSI 七层模型  
	- 应用层
    - 表示层
    - 会话层
    - 传输层
    - 网络层
    - 数据链路层
    - 物理层
- TCP/IP (DoD) 四层模型  
	- 应用层
    - 传输层
    - 网络互联层
    - 主机到网络层


## 应用层

### 应用程序体系结构

- 客户-服务器体系结构
    - 至少一个服务器主机负责处理多个来自客户主机的请求
- P2P体系结构
    - 主机到主机, 这些主机称为对等方

### 基本概念

- 套接字: socket
    - 进程通过socket的软件接口向网络发送报文和传输报文
        - 好比房子的大门
    - 套接字地址: ip + port
- API: Application Programming Interface

### HTTP

HTTP(HyperText Transfer Protocal, 超文本传输协议)是Web的核心, 客户端和服务器通过交换HTTP报文进行会话. HTTP使用TCP作为它的支撑传输协议, 即先建立TCP连接, 再通过TCP连接向彼此套接字发送报文. 

- TCP为HTTP提供了可靠数据传输服务
    - 即发出的每个请求到能完整的到达目的地
- HTTP是一个无状态协议


- 持续连接的HTTP
    - 可以一个接一个发送请求
- 非持续连接的HTTP
    - 发送一个对象后TCP连接关闭


#### HTTP报文格式

请求报文
- 请求行
    - 方法 URL 版本
    - 包含一系列必要信息
- 首部行
    - 首部字段: 值
    - 相当于指定配置
- 空行
- 实体主体
    - 使用POST方法时才使用

``` 
--- 请求行 ---
GET /some/dir HTTP/1.1
--- 首部行 ---
Host: www.some.com           # 指明对象所在的主机, 该首部行的Web高速缓存所要求的
Connection: close            # 非持续连接
User-agent: Mozilla/5.0      # 发送请求的浏览器类型
# 还会有很多的配置
```

HTTP使用的方法
- GET
- POST
- HEAD
    - 类似GET, 但不返回请求对象
- PUT
    - 允许用户上传对象到指定Web服务器
- DELETE
    - 允许用户删除服务器上的对象

响应报文
- 状态行
    - 版本 状态码 短语
    - 常见状态码
        - 200 请求成功
        - 301 请求的对象已被永久转移
        - 400 Bad Request 请求不能被理解
        - 404 Not Found 请求的文档不在服务器上
        - 505 服务器不支持请求报文的HTTP版本
- 首部行
- 空行
- 实体主体


#### cookie

前面提到HTTP服务器是无状态的, 所以要想内容和用户身份联系起来就要使用cookie.

``` sequence-diagrams
client->server: request
server-->client: response + cookie
client->server: request + cookie
server-->client: response
```


#### Web缓存

Web缓存器也叫代理服务器. Web缓存器既是服务器又是客户端, 它会把请求的结果保存在本地. 在遇到相同的请求是可以由本地数据提供

可以减少网络负担. 如在高速的局域网络架设缓存器

HTTP协议有一种机制, 允许缓冲器证实它的对象是最新的. 这种机制叫做**条件GET**. 使用含有`If-Modified-Since: Date`请求行


### FTP

文件传输协议

区别于HTTP, FTP也运行在TCP上, 但是它使用两个并行的TCP连接来传输文件: 一个是**控制连接**, 一个是**数据连接**.


### 因特网中的电子邮件

由三个部分组成: 用户代理, 邮件服务器, 简单传输协议(SMTP).
邮件通过SMTP在邮件服务器中传递, 在由邮件服务器分发给对应用户.


### DNS

域名系统(Domain Name System, DNS)


#### Host

除了DNS可以解析域名外, Host也能解析域名.
IP信息和域名信息的映射表.
Host映射的优先级要高于DNS.


#### DDNS

动态域名系统(Dynamic Domain Name System). 
其主要作用的动态更新dns服务器上的IP地址.
方便域名与IP的映射.  

可以自己写程序/脚本实现
- 思路1:
    - 调用dns服务商的api实现更新ip地址


### 套接字编程


#### TCP

需要建立连接


#### UDP

无连接传输

优点
- 控制更加精细
    - TCP的拥塞控制机制在链路变得拥塞时来遏制运输层的TCP发送方. 
    - TCP会不惜一切时间代价来确认报文被接收且确认, 对于有最小发送速率要求的应用不友好.
    - 对于不希望过分延时但能容忍一些数据丢失的应用来说是好的
- 无需连接建立
    - TCP需要三次握手, 而UDP不会, 故UDP不会引入建立连接时延
- 无状态连接
    - TCP需要维护连接状态, 接收和发送缓存, 拥塞控制参数以及确认号的参数等等
- 首部开销很小

**UDP是可以实现可靠数据传输的**, 通过在报文中添加校验和(checksum). 校验和工作原理如下

``` 
将报文段中 所有的16比特字的和 进行反码运算, 求和时遇到任何溢出都被回卷.
得到的结果放在报文的校验和字段中. 接收方收到后将所有16比特字和检验和相加应该得到16个1

简单举例: 要三个字段
10011
00111
01111

10011
00111
-------
11010
01111
-------
01001

checksum: 10110 # 和的反码
```


## 运输层

运输层协议是在端系统中而不是路由器中实现的. 运输层把应用程序发送的报文转换成运输层分组, 该分组称谓运输层**报文段**.

在发送端系统中, 运输层将这些报文段传递给网络层, 网络层对其封装成网络层分组即(**数据报**)

网络层提供了主机之间的逻辑通信, 而运输层为运行在不同主机上的进程之间提供了逻辑通信.
网络层相当与邮递员负责送到家门口, 分发还得靠运输层, 所以说网络层是运行在主机间, 运输层才是运行在进程间的(端系统), 运输层负责把报文移动到网络边缘(网络层).

- 多路复用
    - 负责收集各个端口的报文, 为每个数据快封装上首部信息后传递到网络层
- 多路分解
    - 运输层负责获取从网络层接收到的报文首部中端口的信息, 并分发到适当的程序中


### 可靠数据传输(RDT)




## 网络层

网络层对运输层发送是分组(数据段)封装成网络层分组, 该分组称为**数据报**.




